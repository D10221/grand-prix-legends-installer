#!/usr/bin/env bash
#
# Grand Prix Legends installer
# Works on:
#  - Ubuntu
#  - Maybe Debian/Ubuntu derivatives
#  - Partially on MACOS
# Tested on:
#  - Ubuntu 20.4
# Requires:
#  - bash
#  - wget
#  - wine
#  - md5sum|shasum
#  - udisksctl
#  - file
#  - grep
# Downloads:
#  - GrandPrixLegends.iso from archive.org
#  - gplinstall_beta_1.08.exe from  grandprixlegends.info
# Description:
#  - Creates wine prefix, mounts iso and runs the installer
#

# this script version
VERSION=0.0.1

GPL_HOME=~/.local/share/grand-prix-legends
GPL_SETUP_HOME="$GPL_HOME/setup"
ISO_URL="https://archive.org/download/grand-prix-legends/GrandPrixLegends.iso"
ISO=$GPL_SETUP_HOME/grand-prix-legends.iso
ISO_MD5="c42ff47a96633e28a6d03afa078b1da2  $ISO"
ISO_SHASUM="082542e01a9e63c914a8f34f77ee306531a2aa13  $ISO"
INSTALLER_URL="http://gem.grandprixlegends.info/gplinstall_beta_1.08.exe"
INSTALLER="$GPL_SETUP_HOME/gplinstall_beta_1.08.exe"
INSTALLER_MD5="dd5b2a23b224dcf553ff7bac9082b045  $INSTALLER"
INSTALLER_SHASUM="5223d8e8c577ec4504fc8c9491b03c61710af263  $INSTALLER"
GEM_URL="http://gem.grandprixlegends.info/GEM/GEMPackage_2.5.0.32.exe"
GEM="$GPL_SETUP_HOME/GEMPackage_2.5.0.32.exe"
GEM_MD5="d82cd2428ce28081a4dca6f3e395e95a  $GEM"
GEM_SHASUM="e8ce456a6db5c2440cb0501accc553730e2ed321  $GEM"
WINEPREFIX="$GPL_HOME/pfx"
ISO_DEVICE="/dev/disk/by-label/GPL"
WINE="$(which wine)"
_filename=$(basename $0)
#
# args:
#   $1  'file'
#   $2  'url'
#
download() {
    if [ ! -f "$1" ]; then
        return $(wget $2 -O "$1")
    fi
    return 0
}
#
# Args:
#   $1  'file'
#   $2  'md5sum'
#   $3  'shasum'
#
verify() {
    local actual=""
    if [ ! -z "$(which shasum)" ]; then
        actual="$(shasum $1)"
        expected=$3
    elif [ ! -z "$(which md5sum)" ]; then
        actual="$(md5sum $1)"
        expected=$2
    else
        echo "Can't verify $1" >&2
        return 1
    fi
    if [ "$actual" != "$expected" ]; then
        # echo "Expected $expected"
        # echo "Actual   $actual"
        echo "Bad hash: $(basename $1)" >&2
        return 1
    fi
    return 0
}
# create targets
createTargets() {
    mkdir -p "$GPL_SETUP_HOME"
    mkdir -p "$WINEPREFIX"
}
#
# Args:
#   $1 $ISO_DEVICE
#
udisksctlInfoBackingFile() {
    local BACKINGFILE=""
    local UDISKSCTL_INFO=$(udisksctl info -b "$1" | grep BackingFile)
    local r="\s+BackingFile:\s+(.*)"
    if [[ "$UDISKSCTL_INFO" =~ $r ]]; then
        echo "${BASH_REMATCH[1]}"
    else
        return 1
    fi
}
#
# install on linux
#
linuxInstall() {
    # create dirs to store downloaded files and prefix
    createTargets
    #
    if ! download $ISO $ISO_URL ||
        ! download $INSTALLER $INSTALLER_URL ||
        ! download $GEM $GEM_URL; then
        echo "Download failed"
        exit 1
    fi
    # verify
    if ! verify $ISO "$ISO_MD5" "$ISO_SHASUM" ||
        ! verify $INSTALLER "$INSTALLER_MD5" "$INSTALLER_SHASUM" ||
        ! verify $GEM "$GEM_MD5" "$GEM_SHASUM"; then
        echo verify failed
        exit 1
    fi
    # if there isn't wine ?
    if [ ! -f "$WINE" ]; then
        echo "can't find wine, get wine on the \$PATH and try again" >&2
        exit 1
    fi
    # Mounting the iso
    # get the device backing file
    local BACKINGFILE="$(udisksctlInfoBackingFile $ISO_DEVICE)"
    # already mounted?
    if [ -f "$BACKINGFILE" ] && [ $BACKINGFILE == $ISO ]; then  # is mounted
        echo "Already mounted $ISO?"
    elif udisksctl loop-setup -f $ISO; then # mount it
        # mounted: update the backing file
        BACKINGFILE="$(udisksctlInfoBackingFile $ISO_DEVICE)"
    fi
    # 
    if ! [ -f "$BACKINGFILE" ]; then
        echo "Can't mount '$ISO' file on '$ISO_DEVICE' device!" >&2
        exit 1
    fi
    #
    if [ $BACKINGFILE != $ISO ];then
        echo "Wrong '$ISO' file on '$ISO_DEVICE' device?" >&2
        exit 1
    fi
    # run
    WINEPREFIX="$WINEPREFIX" wine "$INSTALLER"
    # unmount iso
    if [ -f "$BACKINGFILE" ] && [ $BACKINGFILE == $ISO ] && # is mounted
        !udisksctl unmount -b $ISO_DEVICE; then
        return 1 # failed
    fi
}
#
#
#
darwinInstall() {
    # create dirs to store downloaded files and prefix
    createTargets
    #
    if ! download $ISO $ISO_URL ||
        ! download $INSTALLER $INSTALLER_URL ||
        ! download $GEM $GEM_URL; then
        echo "Download failed"
        exit 1
    fi
    # verify downloaded files
    if ! verify $ISO "$ISO_MD5" "$ISO_SHASUM" ||
        ! verify $INSTALLER "$INSTALLER_MD5" "$INSTALLER_SHASUM" ||
        ! verify $GEM "$GEM_MD5" "$GEM_SHASUM"; then
        echo verify failed
        exit 1
    fi
    # if there isn't wine ?
    if [ ! -f "$WINE" ]; then
        echo "can't find wine, get wine on the \$PATH and try again" >&2
        exit 1
    fi
    # Mounting the iso
    mounted=1
    if hdiutil mount $ISO; then
        mounted=0
    fi
    if ! $mounted; then
        echo "TODO: Can't mount $(basename $ISO), is it mounted already?" >&2
    fi
    echo "TODO: You may not find the CD as a wine drive, sorry"
    # run
    WINEPREFIX="$WINEPREFIX" wine "$INSTALLER"
    # unmount iso
    if $mounted; then
        echo "TODO: Can't unmount $(basename $ISO)" >&2
        exit 1
    fi
}
#
# Main
# TODO: create create grand-prix-legends launch script
# TODO: create grand-prix-legends.desktop
# Display installation details
main() {
    case $OSTYPE in
    linux*)
        if ! linuxInstall; then
            echo "Installation did not complete successfully" >&2
            exit 1
        fi
        ;;
    darwin*)
        if ! darwinInstall; then
            echo "Installation did not complete successfully" >&2
            exit 1
        fi
        ;;
    *)
        echo "Installation for OS '$OSTYPE' is not implemented." >&2
        exit 1
        ;;
    esac
}
#
# usage
#
usage() {
    echo "usage: '$_filename [options]'"
    echo "options:"
    echo "-i --install 'install gpl'"
    echo "-h --help    'show this'"
    echo "-v --version 'show '$_filename' version'"
}
#
if [[ $# -lt 1 ]]; then
    usage
    exit 1
fi
while getopts ":hiv-:" o; do
    case "${o}" in
    -)
        case "${OPTARG}" in
        install)
            echo "usage: ???"
            ;;
        help)
            usage
            exit
            ;;
        version)
            echo $VERSION
            exit 1
            ;;
        *)
            echo "Unknown option --${OPTARG}" >&2
            exit 1
            ;;
        esac
        ;;
    i)
        main
        exit
        ;;
    h)
        usage
        exit
        ;;
    v)
        echo $VERSION
        exit
        ;;
    *)
        if [ "$OPTERR" != 1 ] || [ "${OPTSPEC:0:1}" = ":" ]; then
            echo "Non-option argument: '-${OPTARG}'" >&2
        fi
        echo "Unknown option -${OPTARG}" >&2
        exit 1
        ;;
    esac
done
echo "Unkown args '"$@"'"
